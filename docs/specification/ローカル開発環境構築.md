# ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒæ§‹ç¯‰

# ğŸ†• ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒæ§‹ç¯‰ï¼ˆ**mediasoupï¼ˆSFUï¼‰ç‰ˆ**ï¼‰

ç›®çš„ï¼š

- **mediasoupï¼ˆSFUï¼‰ã§ã® WebRTC å‹•ä½œç¢ºèª**
- Fastifyï¼ˆREST + WebSocket ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ï¼‰ã¨ã®é€£æº
- PostgreSQLï¼ˆDBï¼šé€šè©±å±¥æ­´ãƒ»èª²é‡‘ç®¡ç†ãªã©ï¼‰
- ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚‚æœ¬ç•ªã«è¿‘ã„ **SFU ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£** ã‚’å†ç¾

æ§‹æˆï¼š

- `fastify-app`
  - REST API
  - WebSocket ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ï¼ˆcall_request / call_connected ãªã©ï¼‰
  - mediasoup Worker / Router / Transport / Producer / Consumer ã‚’ç”Ÿæˆ
- `postgres`ï¼ˆèª²é‡‘ãƒ»é€šè©±å±¥æ­´ï¼‰
- ï¼ˆä»»æ„ï¼‰`redis`ï¼ˆèª²é‡‘ã‚¿ã‚¤ãƒãƒ¼ã®åˆ†æ•£ãƒ­ãƒƒã‚¯ï¼‰
- â€» **coturn ã¯ä¸è¦**
  - SFU ã®ãŸã‚ **TURN ã‚’çµŒç”±ã—ãªãã¦ã‚‚**é€šä¿¡å¯èƒ½
  - ãŸã ã—ã€STUN ã¯ WebRTC ç”¨ã«å°ã•ãªã‚‚ã®ã‚’ä½¿ã£ã¦ã‚‚ã‚ˆã„ï¼ˆä»»æ„ï¼‰

---

# ğŸ”· ãƒ­ãƒ¼ã‚«ãƒ«ç”¨ Docker Composeï¼ˆmediasoup ç‰ˆï¼‰

mediasoup ã¯ **UDP ãƒãƒ¼ãƒˆã‚’å¤§é‡ã«ä½¿ã†**ãŸã‚ã€

ãƒ­ãƒ¼ã‚«ãƒ«ã§ã¯ **å›ºå®šç¯„å›²ã® UDP ãƒãƒ¼ãƒˆ ã‚’ Fastify ã‚³ãƒ³ãƒ†ãƒŠã§é–‹æ”¾**ã—ã¾ã™ã€‚

## `docker-compose.yml`

```yaml
version: "3.9"

services:
  app:
    container_name: fastify-app
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/postgres
      MEDIASOUP_LISTEN_IP: "127.0.0.1"
      MEDIASOUP_ANNOUNCED_IP: "127.0.0.1"
      MEDIASOUP_MIN_PORT: 40000
      MEDIASOUP_MAX_PORT: 49999
    ports:
      - "3000:3000" # REST
      - "3001:3001" # WebSocket signaling
      # mediasoup RTP/RTCP port range
      - "40000-49999:40000-49999/udp"
    depends_on:
      - postgres

  postgres:
    container_name: postgres
    image: postgres:16-alpine
    restart: always
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_USER: postgres
      POSTGRES_DB: postgres
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

volumes:
  pgdata:
```

---

# ğŸ”· fastify-app å´ã®è¨­å®šï¼ˆmediasoupï¼‰

`MEDIASOUP_LISTEN_IP` ã¨ `ANNOUNCED_IP` ã‚’ä¸€è‡´ã•ã›ã¦ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‚’æˆç«‹ã•ã›ã‚‹ã€‚

### `mediasoup-config.ts`

```tsx
import {
  WorkerSettings,
  RouterOptions,
  WebRtcTransportOptions,
} from "mediasoup/node/lib/types";

export const workerSettings: WorkerSettings = {
  rtcMinPort: Number(process.env.MEDIASOUP_MIN_PORT),
  rtcMaxPort: Number(process.env.MEDIASOUP_MAX_PORT),
};

export const routerOptions: RouterOptions = {
  mediaCodecs: [
    {
      kind: "audio",
      mimeType: "audio/opus",
      clockRate: 48000,
      channels: 2,
    },
  ],
};

export const webRtcTransportOptions = {
  listenIps: [
    {
      ip: process.env.MEDIASOUP_LISTEN_IP,
      announcedIp: process.env.MEDIASOUP_ANNOUNCED_IP,
    },
  ],
  enableUdp: true,
  enableTcp: false,
  preferUdp: true,
  initialAvailableOutgoingBitrate: 800000,
} satisfies WebRtcTransportOptions;
```

---

# ğŸ”· ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ï¼ˆFastify WebSocketï¼‰

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ä»¥ä¸‹ã®é †åºã§æ¥ç¶šï¼š

1. `/rtc/capabilities`
2. `/rtc/transports`ï¼ˆsend / recvï¼‰
3. `/rtc/producers`ï¼ˆéŸ³å£°é€ä¿¡é–‹å§‹ï¼‰
4. `/rtc/consumers`ï¼ˆç›¸æ‰‹ã®éŸ³å£°ã‚’å—ä¿¡ï¼‰
5. `/rtc/consumers/{id}/resume`
6. **RTP åˆ°é”ã‚¤ãƒ™ãƒ³ãƒˆ â†’ WS-S04 call_connected**
7. æ¯åˆ†ï¼šWS-S05 call_tick
8. ç•°å¸¸åˆ‡æ–­ç›£è¦–ï¼ˆmediasoup Producer close â†’ WS-S07 call_endï¼‰

coturn ã® credential ç”Ÿæˆã¯ **ä¸è¦**ã€‚

---

# ğŸ”· ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆæ¡ˆï¼ˆSFU å‘ã‘ï¼‰

```
project-root/
  docker-compose.yml
  backend/
    Dockerfile
    src/
      index.ts          # Fastify èµ·å‹•
      rtc/
        server.ts       # mediasoup worker/router ç®¡ç†
        transports.ts
        producers.ts
        consumers.ts
      ws/
        signaling.ts    # WebSocketï¼ˆcall_requestç­‰ï¼‰
      api/
        rtc.controller.ts
        call.controller.ts
      db/
  frontend/
    (Vite / Next.js)
  sql/
```

---

# ğŸ”· èµ·å‹•æ‰‹é †ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰

```bash
docker compose up -d
```

èµ·å‹•å¾Œï¼š

- Fastify REST â†’ [http://localhost:3000](http://localhost:3000/)
- WebSocket â†’ ws://localhost:3001
- PostgreSQL â†’ localhost:5432
- mediasoup RTP/RTCP â†’ UDP 40000ã€œ49999ï¼ˆè‡ªå‹•ï¼‰

---

# ğŸ”· WebRTCï¼ˆmediasoupï¼‰ãƒ†ã‚¹ãƒˆ

TURN ã¯ä¸è¦ã ãŒã€STUN å€™è£œã¯ä½¿ãˆã‚‹ã€‚

ä¾‹ï¼šGoogle STUN

```
stun:stun.l.google.com:19302
```

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®æŒ™å‹•ã‚’ç¢ºèªã™ã‚‹ã«ã¯ï¼š

- Chrome â†’ `chrome://webrtc-internals`
- Audio producer / consumer ã®æµé‡ãŒå‡ºã¦ã„ã‚Œã° OK
