# ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒæ§‹ç¯‰

ç›®çš„ï¼š

- WebRTCï¼ˆTURNå¼·åˆ¶ï¼‰ã®å‹•ä½œç¢ºèª
- Fastifyï¼ˆREST + WebSocketï¼‰ã¨ã®é€£æº
- PostgreSQLï¼ˆDBï¼‰
- ãƒ­ãƒ¼ã‚«ãƒ«ã ã‘ã§ã»ã¼æœ¬ç•ªåŒç­‰ã®æµã‚Œã‚’å†ç¾

æ§‹æˆï¼š

- `fastify-app`ï¼ˆAPI + WebSocketï¼‰
- `postgres`ï¼ˆDBï¼‰
- `coturn`ï¼ˆTURNï¼‰
- `nginx`ï¼ˆSPAã‚„APIã®ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ï¼šä»»æ„ï¼‰
- å°†æ¥ï¼š`redis`ï¼ˆèª²é‡‘ã‚¿ã‚¤ãƒãƒ¼ã®ãƒ­ãƒƒã‚¯ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ï¼‰ã‚‚è¿½åŠ å¯èƒ½

---

# ğŸ”· ãƒ­ãƒ¼ã‚«ãƒ«ç”¨ Docker Compose å…¨ä½“å›³

ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ›ã‚¹ãƒˆå´ï¼ˆlocalhostï¼‰ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚

# ğŸ”· æœ€å°æ§‹æˆã® `docker-compose.yml`

ãƒ­ãƒ¼ã‚«ãƒ«ç”¨ã¨ã—ã¦æœ€é©åŒ–ã—ãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã™ã€‚

> â€» é–‹ç™ºç”¨ãªã®ã§èªè¨¼æƒ…å ±ã¯ç°¡æ˜“åŒ–ã—ã¦ã„ã¾ã™ï¼ˆæœ¬ç•ªã§ã¯çµ¶å¯¾NGï¼‰ã€‚
>
> â€» TURN ã¯ TLS ãªã—ã® `3478` ã®ã¿ã§å‹•ä½œï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã§ã¯ã“ã‚Œã§ååˆ†ï¼‰ã€‚

```yaml
version: "3.9"

services:
  app:
    container_name: fastify-app
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/postgres
      TURN_STATIC_SECRET: "my-secret"
      TURN_HOST: "localhost"
      TURN_PORT: 3478
    ports:
      - "3000:3000" # Fastify REST
      - "3001:3001" # Fastify WebSocket
    depends_on:
      - postgres
      - coturn

  postgres:
    container_name: postgres
    image: postgres:16-alpine
    restart: always
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_USER: postgres
      POSTGRES_DB: postgres
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  coturn:
    container_name: coturn
    image: instrumentisto/coturn:latest
    restart: always
    network_mode: "host" # WebRTC ã®ãŸã‚ localhost ã§ãƒãƒ¼ãƒˆé–‹æ”¾
    command:
      - "--log-file=stdout"
      - "--min-port=49160"
      - "--max-port=49200"
      - "--realm=localhost"
      - "--use-auth-secret"
      - "--static-auth-secret=my-secret"
      - "--no-tls"
      - "--no-dtls"
      - "--no-cli"
      - "--no-software-attribute"
      - "--fingerprint"
      - "--lt-cred-mech"
      - "--listening-port=3478"

volumes:
  pgdata:
```

ãƒ•ãƒ­ãƒ³ãƒˆå´ï¼ˆWebRTCï¼‰ã«ã“ã® cred ã‚’ REST ã§é…å¸ƒã—ã¾ã™ã€‚

# ğŸ”· ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆæ¡ˆï¼ˆé–‹ç™ºå‘ã‘ï¼‰

```
project-root/
  docker-compose.yml
  backend/
    Dockerfile
    src/
      index.ts
      ws/
      api/
      db/
  frontend/
    (Vite / Next.jsãªã©)
  sql/
    init.sql
```

# ğŸ”· èµ·å‹•æ‰‹é †ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰

```bash
docker compose up -d
```

èµ·å‹•å¾Œï¼š

- Fastify REST API â†’ [http://localhost:3000](http://localhost:3000/)
- WebSocket â†’ ws://localhost:3001
- PostgreSQL â†’ localhost:5432
- TURN â†’ localhost:3478

ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ SPA ã‚’èµ·å‹•ã—ã¦ WebRTC ã‚’è©¦ã™ã ã‘ã€‚

---

# ğŸ”· ãƒ­ãƒ¼ã‚«ãƒ« TURN ãƒ†ã‚¹ãƒˆæ–¹æ³•

Chrome ã® `chrome://webrtc-internals` ã¨

Google ã® Trickle ICE ã‚’ä½¿ã„ã¾ã™ã€‚

### `http://localhost:3000/api/turn-credential`

ã§ cred ã‚’å–å¾— â†’ Trickle ICE ã«è²¼ã‚‹ â†’ candidate ã« `relay` ãŒå‡ºã‚Œã°æˆåŠŸã€‚
