# A-06 トラフィックモニタ

A-04（通話ログ／モニタリング）が「通話1件ごとの監査」だったのに対し、**A-06 トラフィックモニタは “システム全体のネットワーク・RTC負荷・SFU稼働状況” を可視化する管理画面** です。

WebRTC / SFU（mediasoup）基盤の安定運用のため、リアルタイムの帯域・同時通話数・RTP遅延・CPU負荷などを確認できる設計としています。

---

# 1. 画面概要

管理者がシステム全体の WebRTC / SFU / API のトラフィック状況をリアルタイムで監視する画面。

目的：

- 現在の同時通話数・負荷状況をチェック
- RTP のパケットロス・遅延の増加を早期発見
- ピーク時間帯の傾向を把握
- サーバの CPU / メモリ / ネットワーク帯域を可視化
- 障害の兆候を事前に捉える（健全性監視）

---

# 2. 画面構造（UI）

---

## **ヘッダー**

| 要素 | 内容               |
| ---- | ------------------ |
| 左   | 管理メニュー       |
| 中央 | トラフィックモニタ |
| 右   | 管理者プロフィール |

---

# 3. メインコンテンツ

---

## ① 現在のシステムステータス（サマリー）

画面上部に主要 KPI をカード表示：

```
・同時通話数：12
・SFU 負荷：41%
・平均 RTT：82ms
・パケットロス平均：1.4%
・API リクエスト数（直近1分）：420 req/min
```

ステータスは色で強調：

- 緑 → 正常
- 黄 → 注意
- 赤 → 危険

---

## ② 通話トラフィック（リアルタイム）

折れ線グラフ（1分間隔）：

- 現在の同時通話数（y軸）
- 過去15分 / 1時間の推移

例：

```
12:01  3通話
12:05  8通話
12:10  12通話
12:15  10通話
```

ピーク時間帯の把握に使う。

---

## ③ SFU（mediasoup）負荷状況

### CPU / メモリ / ネットワーク帯域

以下をグラフで表示：

- **CPU使用率（%）**
- **メモリ使用量（GB）**
- **送受信の帯域幅（Mbps）**

例：

```
CPU：41%（安定）
メモリ：2.1GB / 8GB
上り：38Mbps
下り：42Mbps
```

SFUが複数ノードの場合：

```
SFU-1：正常（CPU 35%）
SFU-2：高負荷（CPU 72%）
```

→ ノードごとに色分けして表示。

---

## ④ RTP 品質モニタ（集計）

過去数分間の RTP 指標を集約：

- 平均 RTT（往復遅延）
- パケットロス（%）
- Jitter（ゆらぎ）
- 「異常通話数」

表示例：

```
平均RTT：82ms
平均Jitter：12ms
パケットロス：1.4%
異常通話：1件（詳細へ）
```

しきい値を超えると黄色 / 赤で警告。

---

## ⑤ トラフィックヒートマップ（任意）

1日の中でどの時間帯にトラフィックが多いかを色で表示：

```
6時   □□□■■■
12時  ■■■■■■
18時  ■■■■■■■■■
22時  ■■■■■■■
```

→ 運営判断で増強する時間帯の目安に。

---

## ⑥ システムアラート（重要）

クリティカルログを自動表示：

```
⚠ SFU-2 の CPU 使用率が 80% を超えました
⚠ RTP パケットロスが急増（ユーザーID：user_88）
⚠ メモリ使用量が閾値を超過
```

アラートはクリックで詳細へ（A-04 通話ログの該当通話を開く）。

---

## ⑦ 現在進行中の通話一覧（簡易版）

| 通話ID   | ユーザー | おともはん | RTT   | Loss | 状況  |
| -------- | -------- | ---------- | ----- | ---- | ----- |
| call_220 | user_21  | otomo_02   | 64ms  | 0.5% | 正常  |
| call_229 | user_88  | otomo_01   | 202ms | 3.2% | 警告⚠ |

→ クリックで A-04 の詳細ログへ。

---

## ⑧ CSV / エクスポート（任意）

- 過去のトラフィックログ
- SFU負荷ログ
- RTP品質ログ

監査・障害調査に利用。

---

# 4. API 連動

| 用途               | API                        |
| ------------------ | -------------------------- |
| システムサマリ     | GET /admin/traffic/summary |
| 通話数推移         | GET /admin/traffic/calls   |
| SFU負荷            | GET /admin/traffic/sfu     |
| RTP品質            | GET /admin/traffic/rtp     |
| アラート一覧       | GET /admin/traffic/alerts  |
| 現在の通話簡易一覧 | GET /admin/calls/active    |

定期ポーリング（5〜10秒） or WebSocket でリアルタイム更新。

---

# 5. セキュリティ

- 管理画面の中でも「上級権限（super-admin）」向け
- トラフィックデータは機密性が高い
- アラート通知は外部に漏れないようにログ管理
- APIには厳重な認証（JWT + IP制限）

---

# 6. デザイン仕様

- 情報量が多いためダッシュボード形式
- グラフはライン/棒/ドーナツを用途に応じて使い分け
- アラートは赤のアクセントカラー
- SFUノードが複数の場合は色分け
- 通話一覧はシンプルで要点のみ

---

# 7. 画面レイアウト（概略）

```
[メニュー]           トラフィックモニタ              [管理者]

--- サマリ ---
同時通話数：12   SFU負荷：41%   RTT：82ms   Loss：1.4%

--- 通話トラフィック（折れ線） ---
（グラフ）

--- SFU負荷 ---
CPU/メモリ/帯域（SFU-1, SFU-2）

--- RTP品質 ---
RTT / Loss / Jitter（集計）

--- アラート ---
⚠ SFU-2のCPU 80%
⚠ 通話 call_229 のパケットロス増加

--- 現在進行中の通話 ---
call_220  user_21 otomo_02 64ms / 0.5% 正常 >
call_229  user_88 otomo_01 202ms / 3.2% 警告 >
```
