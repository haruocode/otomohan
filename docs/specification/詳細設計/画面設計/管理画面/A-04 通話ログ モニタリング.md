# A-04 通話ログ / モニタリング

# 1. 画面概要

管理者が以下を行うための画面：

- 過去の通話ログ確認（通話ID別）
- 異常通話（異常切断・不正消費）の検知
- リアルタイムの通話状況の監視（現在進行中の通話一覧）
- おともはん / ユーザーの通話データ比較
- RTP の到達ログ（SFU基盤）
- ステートマシンの遷移履歴確認

通話データは **後から訴訟対策にも使える証跡** なので、保存フォーマット・検索精度・監査性を重視する。

# 2. 画面構造（UI）

---

## **ヘッダー**

| 要素 | 内容                    |
| ---- | ----------------------- |
| 左   | 管理メニュー            |
| 中央 | 通話ログ / モニタリング |
| 右   | 管理者プロフィール      |

---

# 3. メインコンテンツ

---

## ① 通話検索フィルター

検索条件：

- **通話ID（call_xxx）**
- ユーザーID / おともはんID
- 日付範囲（開始〜終了）
- 状態（正常終了 / 異常切断 / 未接続 / 不正疑い）
- 通話時間（0〜1分 / 1〜5分 / 5分以上）
- 課金ポイント（0〜100 / 100〜500 など）

フィルター → 一覧更新。

---

## ② 通話ログ一覧（テーブル）

| 項目       | 説明                                      |
| ---------- | ----------------------------------------- |
| 通話ID     | `call_123`                                |
| ユーザー   | user_001                                  |
| おともはん | otomo_005                                 |
| 開始時刻   | 2025/02/01 12:01                          |
| 終了時刻   | 2025/02/01 12:14                          |
| 通話時間   | 13分                                      |
| 課金       | 300pt                                     |
| 終了理由   | 正常 / 相手切断 / 異常切断 / タイムアウト |
| 操作       | 詳細                                      |

異常の行は赤帯でハイライト：

```
call_992  異常切断（おともはん側）
```

---

## ③ 通話ログ詳細画面（コア機能）

**通話ID：call_123**

### 1) 基本情報

```
ユーザー：user_001
おともはん：otomo_005
開始：2025/02/01 12:01
終了：2025/02/01 12:14
通話時間：13分
課金ポイント：300pt
終了理由：正常終了
```

---

### 2) ステートマシン遷移ログ（重要）

SFU版で導入したステートマシンの遷移履歴を表示：

```
12:01:05   REQUESTING
12:01:07   RINGING
12:01:14   CONNECTING
12:01:15   CONNECTED
12:14:22   ENDING
12:14:23   ENDED
```

異常切断時は赤字表示：

```
12:07:31   RTP停止 → 異常検知
```

---

### 3) RTP到達ログ（SFU監視）

リアルタイムのパケット到達をサマリとして記録：

```
ユーザー → SFU： 正常（平均32ms）
おともはん → SFU： 正常（平均28ms）

パケットロス：1.2%
Jitter：10ms
```

異常例：

```
おともはん → SFU： 0秒以降パケットなし → 異常切断
```

これが **不正な課金防止の裏付けデータ** となる。

---

### 4) 課金ログ（1分ごと）

```
12:02   25pt
12:03   25pt
12:04   25pt
...
12:14   25pt
合計：300pt
```

もしTickが飛んでいれば黄色警告。

---

### 5) 通話品質ログ（任意）

- ラウンドトリップタイム（RTT）
- ネットワーク切断回数
- デバイス情報（OS・ブラウザ）

---

### 6) 通話録音（任意・将来）

録音機能を導入した場合：

```
録音データ：再生 / ダウンロード
```

管理者権限でのみ再生可能。

---

### 7) 不正挙動検知（警告）

自動検知の例：

```
⚠ 同一ユーザーが複数端末から同時接続しました
⚠ 通話開始直後に大量ポイント消費（疑い）
⚠ パケットロス率が異常に高い通話
```

---

## ④ リアルタイムモニタリング（現在進行中）

別タブ or 同画面の下部に表示。

### リアルタイム通話一覧

| 通話ID   | ユーザー | おともはん | 開始時刻 | 経過 | 状況   | RTP状態       |
| -------- | -------- | ---------- | -------- | ---- | ------ | ------------- |
| call_220 | user_21  | otomo_02   | 12:15    | 3分  | 接続中 | 正常          |
| call_221 | user_88  | otomo_01   | 12:18    | 1分  | 接続中 | パケット低下⚠ |

視覚的にモニター可能：

- 緑 → 正常
- 黄 → 警告
- 赤 → 危険

---

## ⑤ エクスポート（CSV / Excel）

- 過去通話ログ
- 異常通話一覧
- RTPログ（縮約版）
- 課金ログ（tickログ）

---

# 4. API 連動

| 用途               | API                               |
| ------------------ | --------------------------------- |
| 通話一覧           | GET /admin/calls                  |
| 通話詳細           | GET /admin/calls/{callId}         |
| RTPログ（縮約）    | GET /admin/calls/{callId}/rtp     |
| 課金ログ           | GET /admin/calls/{callId}/billing |
| ステートマシンログ | GET /admin/calls/{callId}/events  |
| リアルタイム状況   | GET /admin/calls/active           |

必要に応じて WebSocket でも可。

---

# 5. セキュリティ

- 全体が「機密情報」
- IP制限必須
- 操作ログを A-10 に記録
- 通話録音（導入時）は法的に厳格な扱い
- 管理者ロールの中でも権限分割が必要
  - 通話監査権限
  - 録音閲覧権限
  - BAN権限

---

# 6. デザイン仕様

- モニタリング画面はライト/ダークどちらでも可
- 情報量が多いためテーブル中心
- 警告はイエロー、危険はレッド
- グラフは小さめのカードで表示
- ステートマシン履歴は縦タイムライン風に

---

# 7. 画面レイアウト（概略）

```
[メニュー]         通話ログ / モニタリング         [管理者]

検索： [callID] [ユーザーID] [日付] [状態▼] [検索]

---------------------------------------------------------
ID        user     otomo     開始        時間   pt   状態   詳細
call_101  user_01  otomo_02 12:01       10分   250  正常    >
call_102  user_88  otomo_01 12:07       1分    25   異常⚠  >
---------------------------------------------------------

（通話詳細）
call_101

基本：12:01〜12:14 / 13分 / 300pt

ステートログ：
 REQUESTING → RINGING → CONNECTING → CONNECTED → ENDING → ENDED

RTPログ：
 ユーザー→SFU 正常 / おともはん→SFU 正常

Tick課金：
 12:02 25pt
 ...

リアルタイム一覧：
 call_220 user_21 otomo_02 3分 接続中 正常
```
