# SFU 版 通話ステートマシン（状態遷移図）

あなたが設計した課金制 1 対 1 音声通話アプリの要件に最適化した形でまとめます。

# 🎯 目的

P2P ではクライアント側の Self-report が混ざるため正確な状態遷移は困難でしたが、

SFU（mediasoup）ベースにすることで

- **音声 RTP 到達**
- **音声 RTP 停止**
- **WS 切断**
- **ICE fail**
- **課金ロジック（tick）**
- **call_end**

などを用いて **完全にサーバー主導の状態管理** が可能になります。

ここでは、その状態遷移（ステートマシン）を明確化します。

---

# 🧩 **SFU 版 通話ステートマシン（全体図）**

以下のような状態をもつステートマシンになります：

```
IDLE
 ↓ call_request
REQUESTING
 ↓ call_accept
MATCHED
 ↓ RTP到達（SFU）
CONNECTING
 ↓ SFUが接続確定
TALKING
 ↓ RTP停止 / WS切断 / 稼働終了
ENDING
 ↓ cleanup完了
ENDED
```

より詳細な状態で表現するとこうなります：

---

# 🧭 **詳細ステート（8 段階）**

| 状態           | 役割                            |
| -------------- | ------------------------------- |
| **IDLE**       | 通話未開始                      |
| **REQUESTING** | 通話リクエスト送信済み（待機）  |
| **RINGING**    | おともはんが着信画面を表示中    |
| **MATCHED**    | 双方が通話開始に同意（accept）  |
| **CONNECTING** | SFU の Producer/Consumer 作成中 |
| **TALKING**    | 通話中（RTP alive）             |
| **ENDING**     | RTP 停止 or 切断判定後の後処理  |
| **ENDED**      | 完全終了                        |

---

# 📘 **状態遷移（図）**

以下は ASCII 図ですが、工程がすべて見える形にしています。

```
     +--------+
     |  IDLE  |
     +--------+
          |
          | WS: call_request (USER→OTOMO)
          v
  +----------------+
  |  REQUESTING    |
  +----------------+
          |
          | WS-S02 incoming_call (OTOMO側)
          v
   +---------------+
   |   RINGING     |
   +---------------+
          |
          | WS: call_accept
          v
   +---------------+
   |   MATCHED     |
   +---------------+
          |
          | RTC-01～06（Producer/Consumer準備）
          v
   +----------------+
   |  CONNECTING    |
   | (まだ音声なし) |
   +----------------+
          |
          | ★ RTP到達（SFUによる検知）
          | → WS-S04 call_connected
          v
   +---------------+
   |   TALKING     |
   | (通話中・課金) |
   +---------------+
          |
          | 以下のいずれか ↓
          | ・RTP停止（5〜10秒途絶）
          | ・WS切断 → RTPなし
          | ・ICE failed継続
          | ・low_balance
          | ・manual end（終了ボタン）
          v
   +---------------+
   |   ENDING      |
   | (cleanup中)   |
   +---------------+
          |
          | RTC-07（全Transport/Producer/Consumer破棄）
          v
    +-------------+
    |    ENDED    |
    +-------------+
```

---

# 🔥 **各ステートの役割とサーバー処理**

---

## 1. **IDLE**

まだ通話を開始していない状態。

---

## 2. **REQUESTING（通話リクエスト送信）**

- ユーザーが通話ボタンを押した状態
- WebSocket で `call_request` 送信
- おともはんへ `incoming_call` が送られる

UI：

- 「おともはんの応答待ち...」

---

## 3. **RINGING（呼出し中）**

- おともはん側が着信画面を見ている状態

UI：

- おともはん：「着信中…」画面

---

## 4. **MATCHED（両者同意）**

- WS で `call_accept` を受けた段階
- ここではまだ音声は流れない
- SFU Resource 作成の準備フェーズへ

サーバー：

- Room を作り、Router を準備

---

## 5. **CONNECTING（SFU 準備・音声未接続）**

行うこと：

- RTC-01 capabilities 取得
- RTC-02 send/recv transport 作成
- RTC-03 DTLS connect
- RTC-04 Producer 作成（音声送信）
- RTC-05 Consumer 作成（音声受信）
- RTC-06 Consumer resume

**まだ音声は流れていない**

→ **RTP を受信するまでは通話開始ではない**

---

## 6. **TALKING（通話中・課金）**

SFU が **RTP を初めて受信した瞬間に** 遷移。

トリガー：

```
producer.on('trace' type='rtp')
→ room.state = TALKING
→ WS-S04 call_connected
→ 課金開始（tick timerスタート）
```

UI：

- 通話画面（相手の音声が聞こえる）
- タイマー開始

---

## 7. **ENDING（終了処理中）**

トリガー：

- RTP 停止（5〜10 秒）
- WS 切断後に RTP 来ず
- ICE failed 継続
- low_balance（残高不足）
- manual（ユーザーが終了ボタン）

サーバー：

- WS-S07 call_end を送信
- 課金停止
- 通話履歴を確定
- RTC-07 Cleanup API（Transport/Producer/Consumer 破棄）

UI：

- 終話画面 U-05 への遷移

---

## 8. **ENDED（完全終了）**

Room が破棄された状態。

ユーザー側の UI：

- おともはん一覧（U-01）へ戻るなど

---

# 🎛 **SFU 版ステートマシンが持つメリット**

| 項目             | P2P              | SFU 版                             |
| ---------------- | ---------------- | ---------------------------------- |
| 通話開始の確実性 | 低い（自己申告） | **100%（RTP 検知）**               |
| 異常切断検知     | ほぼ不可能       | **RTP 停止で確実に判定**           |
| 課金の正確性     | 誤差あり         | **秒単位で正確**                   |
| 不正対策         | 弱い             | **クライアントの“嘘”が通用しない** |
| ステート管理     | 不安定           | **サーバー集中型で安定**           |

---

# 🎨 UI/UX 上の自然な挙動（まとめ）

### TALKING → ENDING → ENDED の流れは

「通話が突然切れても自然に扱える」ように設計できる。

例：

```
（突然無音）
↓
5秒後：切断検知
↓
call_end受信
↓
通話終了画面へ
```

ユーザーは混乱しない。

---

# 📌 さらに細かい状態にしたい場合（オプション）

Zoom や Discord のように下記を追加することも可能：

- reconnecting（短時間の RTP 途絶）
- degraded（音質劣化）
- muted_by_server（強制ミュートなど）

必要であれば追加バージョンも作れます。
