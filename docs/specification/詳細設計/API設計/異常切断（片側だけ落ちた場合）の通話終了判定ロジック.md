# 異常切断（片側だけ落ちた場合）の通話終了判定ロジック

ここは **商用レベルの音声通話サービスで最も難しい領域** なので、SFU（mediasoup）を基点にした「異常切断判定の正しいやり方」を、実際のサービス（Discord / Zoom / LINE）と同じ思想でまとめます。

「ユーザーのアプリが落ちた」「ネットワークが瞬断した」こうした状況でも **サーバーが確実に通話終了を判定する必要があります**。P2P ではできませんでしたが、SFU を使うことで確実に判定できるようになります。

---

# 🔍 切断シナリオは大きく 3 種類ある

## ① アプリ終了（バックグラウンド落ち／タスクキル）

## ② ネットワーク断（Wi-Fi → LTE ハンドオーバーや地下鉄など）

## ③ WebSocket 切断（意図せず or 意図的）

**すべてに共通するのは：送信者側の RTP が止まること。**

つまり、SFU では

### **“RTP 停止（producer RTP trace が途絶）”が最も信頼できる終了判定**

---

# 🧠 **SFU ベースの異常切断ロジック：全体像**

終了判定に使う信号は 3 つ。

---

# 【1】RTP トラフィック停止（最重要・最強の根拠）

mediasoup の Producer ごとに「最後に RTP を受信した時間」を記録しておき、

### **最後の RTP から 10 秒経過 → 異常切断と判定**

```
if (now - lastRtpAt > 10秒)
    → call_end("rtp_stopped")
```

**長所：**

- 音声が“本当に流れているか”だけを見ているため信頼度 100%
- クライアント側の嘘・不正が通用しない
- ネットワーク状況によるフェイクの影響も低い

**短所：**

- 無音の状態でも RTP パケット（Silence packet）は送られるため問題なし
  → 音声が無音でも RTP は流れるので誤判定は起きない
- 貧弱なネット環境で 2〜3 秒止まることもあるため、10 秒などの猶予が必要

---

# 【2】Transport の ICE / DTLS ステータス（補強ロジック）

次の状態に変わったら危険レベル：

- `iceState = "failed"`
- `connectionState = "closed" or "failed"`
- `dtlsState = "failed"`

ただし **一瞬 failed → succeeded に戻ることがある（モバイル環境）**。

そのため：

```
ice failed → 即終了にはしない
ice failed が 5秒継続 → call_end
```

のように「持続性」を条件に入れると誤判定を避けられる。

---

# 【3】WebSocket 切断（補助的要素）

WebSocket 切断は：

- アプリ終了
- スリープ
- Chrome タブを閉じる
- OS によるバックグラウンド停止
- ネットワーク断

などの要因が混在するため **単独では信用してはいけない**。

しかし

### WS 切断 → 5 秒以内に RTP が来なければ → 終了

という **ハイブリッド判定** にすると非常に強い。

---

# 🎯 実運用で最強なのは「RTP + WS + ICE」の複合判定」

以下のようにまとめられます：

---

# 🎛 **異常切断の複合ロジック（実装推奨版）**

### 1. **RTP 停止が 10 秒以上 → 100%通話終了**

```
if (now - lastRtpAt > 10秒):
    call_end("rtp_stopped")

```

これがメイン。

### 2. **WS 切断 → RTP 監視モード → 5 秒間 RTP 来なければ終了**

```
ws disconnected → flag: waiting_for_rtp

if waiting_for_rtp & (now - lastRtpAt > 5秒):
    call_end("disconnect")
```

実際の Discord / Zoom でも同じ。

### 3. **ICE failed が 5 秒以上継続 → RTP が来ていない → 終了**

```
if iceState failed for >5秒 and (now - lastRtpAt > 5秒):
    call_end("network_failed")
```

これで地下鉄・エレベータでも正しく動く。

---

# ⭐ **call_end の発火はサーバー側だけが行う**

クライアントは **一切 call_end を送らない**。

すべて SFU と API サーバーが統合して判断する。

この設計により：

- 不正行為者が「課金を逃れるために即終了通知」を送ることができない
- P2P 時代の「終了通知来ない問題」が完全に消える
- 異常切断時もサーバーで正確に課金停止できる

---

# 🚨 誤判定を防ぐ工夫（実サービスの知見）

| 問題                      | 対策                                  |
| ------------------------- | ------------------------------------- |
| ネットが一瞬切れる        | 5〜10 秒の猶予を持たせる              |
| 無音状態（喋ってない）    | 無音でも RTP は飛ぶので OK            |
| モバイル環境の瞬断        | ICE failed を短時間で終了理由にしない |
| BFU（Android タスクキル） | WebSocket 切断 + RTP 停止の複合判定   |

---

# 🧩 call_end の reason 一覧

| reason             | 説明                               |
| ------------------ | ---------------------------------- |
| `"rtp_stopped"`    | メイン。音声が完全に途絶。最も確実 |
| `"disconnect"`     | WS 切断後に RTP が来なかった       |
| `"network_failed"` | ICE 失敗の継続で終了               |
| `"low_balance"`    | 課金残高ゼロによる強制終了         |
| `"manual"`         | 明示的に切断（終了ボタン）         |

---

# 🎬 正式なシーケンス例：片側が異常で落ちた場合

```
User app is terminated
↓
WebSocket disconnected
↓
SFU はまだ RTP を受信している（数秒残る）
↓ ここで即終了しない
5秒経過
↓
RTP 停止検知（lastRtpAtが5秒以上前）
↓
call_end(reason="disconnect")
↓
課金停止
↓
通話終了画面へ
↓
RTC-07 cleanup
```

---

# 🧠 この設計のメリット（サービス品質レベルが跳ね上がる）

| 要素         | P2P 時代   | SFU 版                         |
| ------------ | ---------- | ------------------------------ |
| 異常切断検知 | ほぼ不可能 | **100%判定可能**               |
| 課金の正確さ | リスクあり | **正確**                       |
| ユーザー体験 | 切断が曖昧 | **一定秒数後に明確に終了**     |
| 不正対策     | 無し       | **クライアントを信じない方式** |

---

# 🌟 最終まとめ

- **通話終了はサーバー（SFU + WS）だけが決める**
- 最も信用できるのは **RTP 停止**
- 補助として **WS 切断**、**ICE 失敗** を組み合わせる
- 誤判定を避けるために **5〜10 秒の猶予**
- 終了理由ごとに `call_end(reason="...")` を共通フォーマットで送信

これが **商用レベルの異常切断処理の正解** です。
