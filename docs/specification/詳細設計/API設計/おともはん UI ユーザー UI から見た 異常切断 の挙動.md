# おともはん UI / ユーザー UI から見た 異常切断 の挙動

ここでは「UX（ユーザー体験）をどう設計すべきか？」がテーマです。

---

# 🎯 なぜ UI 側の挙動設計が重要か？

異常切断はユーザー側の体験に直結します：

- 相手がアプリ落ち
- 地下鉄で電波が切れた
- スマホの画面消灯 → OS が WebView を止めた
- バックグラウンド遷移
- 電池切れ
- 予期せぬブラウザ終了

この時 UI をどう振る舞わせるかが

サービス品質・信頼性・クレーム防止に直結します。

---

# 📱 **UI 視点での異常切断パターン**

UI を考える際は、下記 4 パターンに分類できます。

| パターン                         | 状況                       | 説明                     |
| -------------------------------- | -------------------------- | ------------------------ |
| ① 相手側が異常切断               | 相手のアプリ落ち／ネット断 | **自分は通話画面のまま** |
| ② 自分側が異常切断               | 自分のアプリ落ち／ネット断 | 復帰後の処理が必要       |
| ③ 自分側のネット揺らぎ（短時間） | パケットロスなど           | 数秒は継続扱い           |
| ④ 双方問題なしだが課金切れ       | 残ポイントゼロ             | 強制終了 UI に切り替え   |

---

# 🟦 **1. 相手側が異常切断したとき（ユーザー UI / おともはん UI 共通）**

## SFU 側の動き

相手の RTP が 5〜10 秒届かない

→ SFU が異常切断と判定

→ **call_end(reason="rtp_stopped" or "disconnect")** が両者に届く

## UI の推奨挙動

### （1）通話画面に「相手との接続が切れました」表示

```
・接続が途切れました
・この通話は終了しました
```

### （2）通話が終了した画面に遷移（U-05）

- 「通話時間」
- 「消費ポイント」
- 「評価（任意）」
- 「閉じる」ボタン

### （3）自動的にミュート・スピーカー OFF（不要な音を出さない）

### （4）UI のボタンを非操作状態にする

- 相手がもう存在しないため、押しても無効

---

# 🟦 **2. 自分側が異常切断した場合（復帰時の UI 挙動）**

例：

- アプリ落ち
- ブラウザタブ再読み込み
- ネットが一瞬死んだ
- OS の挙動で WebView 停止

## 復帰方法パターン：

### ① アプリ復帰後、「通話復帰画面を表示しない」

理由：

SFU の異常切断判定は **自分が落ちても相手が落ちても数秒猶予がある**

→ 復帰してももう通話は続いていない可能性が高い

→ 安全策として **通話はもう復帰しない**

### UI の流れ：

1. アプリ再起動
2. `/auth/me` 取得
3. Top 画面（U-01）へ戻る
4. 直前の通話が `call_end` 済なら

   → CallEnd 画面（U-05）を表示してよい

   → ただし自動復帰通話はしない

### メッセージ表示例

- 「先ほどの通話は切断されました」
- 「ネットワークの問題で通話が終了しました」

---

# 🟦 **3. 短時間のネット揺らぎ（ユーザーには何も見せない）**

モバイル環境では本当に頻繁に起きます。

例：

- 3 秒くらい音が止まる
- LTE→WiFi への切替の間の瞬断
- 一時的なパケットロス

### SFU 側の挙動

- RTP が 5 秒以内に復帰 → 通話継続扱い

### UI の理想挙動

### （1）画面には何も出さない（ユーザーを不安にさせない）

ただし数秒間音声が止まるのは自然。

### （2）音声が復帰したら自動的に続行

### （3）極端に品質が悪い場合のみ軽いトースト通知

例：

```
ネットワークが不安定です
```

---

# 🟦 **4. 残ポイント不足による強制終了**

これは異常切断ではないが、「突然終わる」扱いなので UI としては同じ分類。

SFU or サーバー側課金ロジックが

- `status = "low_balance"`
- 次の tick で `"ended"`

になった場合、call_end(reason="low_balance") が届く。

### UI 挙動：

- 通話中画面 → 「ポイントが不足したため通話終了」ポップアップ
- CallEnd 画面（U-05）へ遷移
- ウォレットへの導線を提示（U-06）

---

# 🔶 UI ステートの変化を一覧で整理（重要）

| 状態           | 発生イベント        | ユーザー UI             | おともはん UI      |
| -------------- | ------------------- | ----------------------- | ------------------ |
| talking        | 通常時              | 通話画面                | 通話画面           |
| network_glitch | RTP 停止 < 5 秒     | 見せない                | 見せない           |
| rtp_lost       | RTP 停止 > 5〜10 秒 | 終了通知 → CallEnd 画面 | 同じ               |
| ws_disconnect  | WS 切断 → RTP 停止  | 再接続後に終話表示      | 相手側にも終話通知 |
| low_balance    | 課金ロジックの終了  | 「残ポイント不足」表示  | CallEnd 画面       |

---

# 🧩 「相手アプリ終了」と「自分アプリ終了」を UI で区別するべきか？

結論：

### → **表示は同じでよい**

理由：

- 技術的にどちらが落ちたか 100%判定するのは難しい
- UI 的に区別してもユーザーメリットがない
- 通話終了という事実だけが重要
- クレーム回避の観点でも曖昧にしておいた方が安全

**表示例：**

```
通話が終了しました。
接続が途切れた可能性があります。
```

---

# 🧠 片側だけ落ちたときの UX でやってはいけないこと

| NG                                        | 理由                              |
| ----------------------------------------- | --------------------------------- |
| 「相手がアプリを終了しました」と断定表示  | 技術的に断定困難・クレームになる  |
| 復帰したら自動で通話に再参加させる        | セキュリティリスク & 仕様的に破綻 |
| 10 秒揺らぎで毎回「接続中断」ポップを出す | うるさすぎる & 誤判定             |

---

# 🎨 おともはん／ユーザー UI モック（簡易）

### 通話中画面（U-04）

```
[相手の名前] と通話中
00:03:12

（マイクON/OFF） （スピーカー） （終了）
```

### 異常切断後

```
通話が終了しました
ネットワークの問題で接続が切れた可能性があります

通話時間：03:12
消費ポイント：120 pt

[閉じる]
```

---

# ✨ 最終まとめ

UI は次の 3 本柱で考える：

---

## ① 終了検知はサーバー（SFU）が実施 → UI は call_end を必ず受け取る

→ クライアント側の処理は「受けるだけ」。

→ 異常切断でも安心。

---

## ② “小さな揺らぎ” は UI に出さない

→ 通常の通信環境では数秒の無音が起こり得る。

→ それでユーザーを不安にさせてはいけない。

---

## ③ 終話画面（U-05）が中心の UX

→ まとめて全部ここに落とす

→ シーケンス断絶があっても UI が破綻しない
