# データベース設計

テーブルは以下の通り。

- users
- otomo_profiles
- wallets
- point_transactions
- calls
- call_billing_units
- call_participants
- call_events
- ws_connections
- system_locks (任意)

※ 中心は「calls」「call_billing_units」「point_transactions」「wallets」の 4 テーブル。

## 1. users (ユーザー＆おともはん共通)

```jsx
CREATE TABLE users (
  id             UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  role           TEXT NOT NULL CHECK (role IN ('user', 'otomo')),
  name           TEXT NOT NULL,
  avatar_url     TEXT,
  created_at     TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at     TIMESTAMP NOT NULL DEFAULT NOW()
);
```

- おともはん専用の情報は別テーブル otomo_profiles に保存。
- ログイン情報は Supabase Auth に任せる想定。

## 2. otomo_profiles (おともはん専用属性)

```jsx
CREATE TABLE otomo_profiles (
  id            UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  description   TEXT,
  is_available  BOOLEAN NOT NULL DEFAULT FALSE,
  hourly_rate   INTEGER NOT NULL DEFAULT 100, -- 1分100ptなら100を設定
  rating        NUMERIC(3,2) DEFAULT 0,
  total_calls   INTEGER DEFAULT 0,
  updated_at    TIMESTAMP NOT NULL DEFAULT NOW()
);
```

## 3. wallets (ポイント残高)

```jsx
CREATE TABLE wallets (
  user_id       UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  balance       INTEGER NOT NULL DEFAULT 0,
  updated_at    TIMESTAMP NOT NULL DEFAULT NOW()
);
```

- balance はポイント残高。
- チャージ後・消費後に updated_at を更新。

## 4. point_transactions (ポイントログ)

ユーザーのポイント履歴すべてを記録します。

```jsx
CREATE TABLE point_transactions (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id       UUID NOT NULL REFERENCES users(id),
  call_id       UUID, -- 通話課金のときだけセット
  type          TEXT NOT NULL CHECK (type IN ('charge', 'spend', 'refund')),
  amount        INTEGER NOT NULL, -- 正:チャージ, 負:消費
  description   TEXT,
  created_at    TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_point_tx_user ON point_transactions(user_id);
CREATE INDEX idx_point_tx_call ON point_transactions(call_id);
```

- 請求書画面を簡単に作れる
- 不正チェックしやすい
- 返金処理もしやすい

## 5. calls (通話本体テーブル)

```jsx
CREATE TABLE calls (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  user_id  UUID NOT NULL REFERENCES users(id),
  otomo_id UUID NOT NULL REFERENCES users(id),

  status TEXT NOT NULL,
  -- "requesting" | "ringing" | "matched" | "connecting" | "talking" | "ending" | "ended"

  reason_ended TEXT,
  -- UIに表示する終了理由: "manual" | "low_balance" | "disconnect" | "otomo_reject" など

  reason_ended_detail TEXT,
  -- システム内部理由: "rtp_stopped" | "ws_disconnect" | "ice_failed" | "manual" など

  created_at       TIMESTAMP NOT NULL DEFAULT NOW(),
  accepted_at      TIMESTAMP,
  ended_at         TIMESTAMP,

  duration_seconds INTEGER,

  total_charged_points INTEGER DEFAULT 0,

  -- ★ SFU追加分
  sfu_connected_at TIMESTAMP,    -- 最初のRTPを受信した瞬間
  sfu_last_rtp_at  TIMESTAMP,    -- 最後にRTPを受けた瞬間
  sfu_node         TEXT,         -- 複数SFU運用時に使用（任意）

  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);
```

- started_at は WebRTC が in_call に入った瞬間 (重要)
- total_seconds は finishing / ended フェーズで決定
- reason_ended で終了理由をすべて把握可能

## 6. call_billing_units (1 分ごとの課金ユニット)

1 分ごとに 45 pt 消費した記録を確実に残すためのテーブル。

```jsx
CREATE TABLE call_billing_units (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  call_id         UUID NOT NULL REFERENCES calls(id) ON DELETE CASCADE,
  unit_index      INTEGER NOT NULL, -- 0,1,2... （n分目）
  points          INTEGER NOT NULL, -- 通常100
  charged_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE UNIQUE INDEX idx_call_billing_unique
  ON call_billing_units(call_id, unit_index);
```

- サーバの課金タイマーが 2 重実行されても unique constraint で二重課金を防げる
- ユーザーの明細画面で「n 分で xx pt」など表示できる
- 統計情報 (平均通話時間、LTV など) も作りやすい

# 7. call_events

通話中に発生したイベントをすべて記録する監査ログテーブルです。

**SFU イベント・課金イベント・WS イベントなど全て記録可能。**

トラブル調査・品質改善・不正対策のために必須レベルの価値があります。

---

## ■ call_events テーブル

```sql
CREATE TABLE call_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  call_id UUID NOT NULL REFERENCES calls(id),
  type TEXT NOT NULL,
  -- 例:
  -- "sfu.rtp_start"
  -- "sfu.rtp_stop"
  -- "sfu.ice_fail"
  -- "ws.disconnect"
  -- "billing.tick"
  -- "billing.low_balance"
  -- "call.end"

  data JSONB,     -- イベントに付随する詳細情報（任意）
  created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_call_events_call_id ON call_events(call_id);

```

---

### ▼ 保存される event 例

| type            | data 例                                |
| --------------- | -------------------------------------- |
| `sfu.rtp_start` | `{ "producerId": "...", "at": "..." }` |
| `sfu.rtp_stop`  | `{ "durationNoRtpMs": 12000 }`         |
| `ws.disconnect` | `{ "userId": "..." }`                  |
| `billing.tick`  | `{ "points": 120, "balance": 800 }`    |
| `call.end`      | `{ "reason": "rtp_stopped" }`          |

**システム内部で起きていることをすべて監査可能にするためのテーブルです。**

# 8. call_participants

1 対 1 通話でも、**参加者情報（JOINED/LEFT）を保存するメリットは大きい** ため作成を推奨します。

将来的に：

- 多重ログイン対策
- 同一ユーザーが複数デバイスから接続したケース
- ログイン → 切断 → 再ログインの参加履歴

などにも活用できます。

---

## ■ call_participants テーブル（新規）

```sql
CREATE TABLE call_participants (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  call_id UUID NOT NULL REFERENCES calls(id),
  user_id UUID NOT NULL REFERENCES users(id),

  role TEXT NOT NULL,
  -- "user" | "otomo"

  joined_at TIMESTAMP NOT NULL DEFAULT NOW(),
  left_at   TIMESTAMP
);

CREATE INDEX idx_call_participants_call_id ON call_participants(call_id);

```

---

### ▼ 主な用途

| 用途          | 説明                                      |
| ------------- | ----------------------------------------- |
| 切断調査      | 「どちらが先に切れたか」を追える          |
| 課金監査      | 通話開始〜終了の正確な参加時間            |
| トラブル対応  | “切れていたのに課金された” の証明ができる |
| 将来 SFU 拡張 | 多人数通話にスムーズに拡張できる          |

## 主なリレーションの図

```jsx
users
 ├── wallets (1:1)
 ├── point_transactions (1:N)
 └── calls (user_id / otomo_id)

calls
 ├── call_billing_units (1:N)
 ├── call_events (1:N)
 └── call_participants (1:N) ※将来用
```

## このスキーマが満たす要件

### サーバ側 authoritative な課金ロジック

- billing_unit (1 分ごと) + point_transactions によって完全保証

### 二重課金の防止

- unique constraint (call_id, unit_index)
- トランザクション単位の ACID

### 通話履歴が完全に再現できる

- calls / call_events / billing_units

### UI でも明細表示しやすい

- 「n 分通話 → xx pt \* N」が復元できる

### おともはんのランキングや統計も作れる

- total_calls, call_billing_units から計算可

### WebRTC / WS の例外発生にも強い

- network_lost / failed も reason_ended として記録

**「変更・追加のあるテーブルだけ」** を対象に、

**正式なデータベース設計書（最新版）** をまとめます。

対象：

- `calls`（SFU 対応のための列追加あり）
- `call_events`（新規追加）
- `call_participants`（新規追加）

以下は **PostgreSQL / Supabase / Prisma いずれでも使いやすい形式** に整えています。
