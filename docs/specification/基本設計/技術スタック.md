# 技術スタック

本プロジェクト「おともはん」は、**1 対 1 音声通話・リアルタイム課金・将来的な監査／録音拡張**を前提とした設計とする。そのため、**リアルタイム通信に強く、状態管理とトランザクション制御を重視できる技術構成**を採用する。

---

### **フロントエンド**

- **TypeScript**
- **React**
- **TanStack Start**

### **採用理由**

- 型安全を重視し、API・WebSocket・状態管理の整合性を保つため
- React によるコンポーネント分離で、通話画面・着信画面・課金表示などを明確に分離できる
- TanStack Start により、将来的なルーティング拡張・データフェッチ戦略の柔軟性を確保

---

### **バックエンド（API / リアルタイム通信）**

- **TypeScript**
- **Fastify**
- **WebSocket（ws ベース）**

### **採用理由**

- Fastify は高パフォーマンスかつ WebSocket との親和性が高い
- REST API と WebSocket を同一言語・同一設計思想で管理できる
- 通話状態マシン・課金 tick・シグナリングなど、**サーバ主導の状態管理**を実装しやすい

---

### **音声通話・リアルタイム通信**

- **WebRTC**
- **mediasoup（SFU）**
- **coturn（STUN / TURN）**

### **採用理由**

- WebRTC によりブラウザ・モバイル両対応の音声通話を実現
- mediasoup を採用することで、以下を将来的に可能にする
  - 通話の安定中継（SFU）
  - 録音・モニタリング
  - 通信品質の監視
- coturn（TURN）を併用し、
  - キャリア NAT
  - 企業ネットワーク
  - 公衆 Wi-Fi
    などの環境でも **確実に接続できる構成**とする

※ mediasoup を利用する場合でも、TURN は実質必須とする

---

### **データベース**

- **PostgreSQL**

### **採用理由**

- トランザクション制御・ロック機構が強力
- 課金・通話状態・イベントログなど、**整合性が最重要なデータ**を安全に管理できる
- JSONB による柔軟なイベントログ保存が可能

---

### **DB アクセスレイヤ**

- **Kysely**

### **採用理由**

- ORM ではなく、**型安全な SQL クエリビルダー**
- DB 設計（calls / billing / wallets など）を歪めずに実装できる
- 明示的なトランザクション制御が可能で、
  - 毎分課金
  - 冪等性
  - 二重課金防止
    を安全に実装できる

---

### **インフラ**

- **Azure**

想定構成：

- Web API / WebSocket：Azure Functions または VM / Container
- PostgreSQL：Azure Database for PostgreSQL
- TURN / mediasoup：VM または Container 上で運用

### **採用理由**

- マネージドサービスが充実しており、初期運用コストを抑えやすい
- スケールアウト・監視・ログ基盤を後から追加しやすい
- WebRTC / TURN / SFU を **分離配置**できる柔軟性

---

### **補足方針**

- 課金・通話状態は **必ずサーバ主導（authoritative）**
- クライアントは状態を「要求」するだけで、最終判断はサーバが行う
- 仕様は WebSocket イベント定義・DB 設計を一次情報とする

---

このまま **「基本設計 ＞ 技術スタック」ページに貼って OK**です。

次にやるなら自然なのは：

- 「技術選定の理由（非採用技術）」ページ追加
- 「アーキテクチャ構成図」用の文章整理
- 「mediasoup / coturn 配置方針」の明文化

どれを続けますか？
